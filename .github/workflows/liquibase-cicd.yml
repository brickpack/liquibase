name: Liquibase CI/CD

on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      database:
        description: 'Database to target (or all)'
        required: false
        default: 'all'
        type: string
      action:
        description: 'Action to perform'
        required: false
        default: 'auto'
        type: choice
        options:
        - auto
        - test
        - deploy

permissions:
  id-token: write
  contents: read

jobs:
  discover-databases:
    runs-on: ubuntu-latest
    outputs:
      databases: ${{ steps.discover.outputs.databases }}
      test-mode: ${{ steps.determine-mode.outputs.test-mode }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Discover databases
      id: discover
      run: |
        databases=$(find . -name "changelog-*.xml" -type f | grep -v "changelog-bootstrap.xml" | sed 's|./changelog-||g' | sed 's|\.xml||g' | jq -R -s -c 'split("\n")[:-1]')
        echo "Found databases: $databases"
        echo "databases=$databases" >> $GITHUB_OUTPUT

    - name: Determine execution mode
      id: determine-mode
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          if [[ "${{ github.event.inputs.action }}" == "test" ]]; then
            echo "test-mode=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event.inputs.action }}" == "deploy" ]]; then
            echo "test-mode=false" >> $GITHUB_OUTPUT
          else
            # Auto mode
            if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
              echo "test-mode=false" >> $GITHUB_OUTPUT
            else
              echo "test-mode=true" >> $GITHUB_OUTPUT
            fi
          fi
        elif [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]]; then
          echo "test-mode=false" >> $GITHUB_OUTPUT
        else
          echo "test-mode=true" >> $GITHUB_OUTPUT
        fi

  liquibase:
    needs: discover-databases
    runs-on: ubuntu-latest
    strategy:
      matrix:
        database: ${{ fromJson(needs.discover-databases.outputs.databases) }}
      fail-fast: false

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Skip if specific database selected
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.database != 'all' && github.event.inputs.database != matrix.database
      run: |
        echo "Skipping ${{ matrix.database }} as ${{ github.event.inputs.database }} was selected"
        exit 0

    - name: Configure AWS credentials
      if: needs.discover-databases.outputs.test-mode == 'false'
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: ${{ vars.AWS_ROLE_ARN }}
        aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Liquibase and drivers
      run: ./.github/scripts/setup-liquibase.sh

    - name: Analyze changelog structure
      run: ./.github/scripts/analyze-changelog.sh ${{ matrix.database }}

    - name: Validate SQL syntax
      run: |
        echo "ğŸ” Validating SQL syntax for ${{ matrix.database }}..."

        # Find all SQL files referenced by this changelog
        SQL_FILES=$(grep -o 'file="[^"]*\.sql"' changelog-${{ matrix.database }}.xml | sed 's/file="//g' | sed 's/"//g')

        if [ -z "$SQL_FILES" ]; then
          echo "â„¹ï¸ No SQL files found to validate"
          exit 0
        fi

        echo "ğŸ“„ Found SQL files to validate:"
        echo "$SQL_FILES"
        echo ""

        # Check each SQL file for basic syntax issues
        VALIDATION_ERRORS=0

        for sql_file in $SQL_FILES; do
          if [ ! -f "$sql_file" ]; then
            echo "âŒ File not found: $sql_file"
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
            continue
          fi

          echo "ğŸ” Validating: $sql_file"

          # Check for common SQL syntax issues
          # 1. Check for unterminated quotes
          quote_error=0
          grep -n "'\|\"" "$sql_file" | grep -v "^[[:space:]]*--" | while read -r line; do
            line_num=$(echo "$line" | cut -d: -f1)
            content=$(echo "$line" | cut -d: -f2-)

            # Count single quotes (ignoring comments)
            single_quotes=$(echo "$content" | grep -o "'" | wc -l)
            if [ $((single_quotes % 2)) -ne 0 ]; then
              echo "âš ï¸  Line $line_num: Possible unterminated single quote"
              echo "1" > /tmp/quote_error_$$.tmp
            fi
          done
          
          if [ -f "/tmp/quote_error_$$.tmp" ]; then
            echo "âŒ Quote validation failed for $sql_file"
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
            rm -f /tmp/quote_error_$$.tmp
          fi

          # 2. Check for dollar quote issues
          # Extract all dollar quote tags from the entire file
          dollar_tags=$(grep -o '\$[^$]*\$' "$sql_file" | sort | uniq -c)
          
          # Check if each tag appears an even number of times
          dollar_quote_error=0
          while read -r count tag; do
            if [ -n "$tag" ] && [ $((count % 2)) -ne 0 ]; then
              echo "âš ï¸  Unmatched dollar quote tag: $tag (appears $count times)"
              dollar_quote_error=1
            fi
          done <<< "$dollar_tags"
          
          if [ $dollar_quote_error -eq 1 ]; then
            echo "âŒ Dollar quote validation failed for $sql_file"
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
          fi

          # 3. Check for required Liquibase headers
          if ! grep -q "^--liquibase formatted sql" "$sql_file"; then
            echo "âŒ Missing Liquibase header in $sql_file"
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
          fi

          # 4. Check for changeset format
          if ! grep -q "^--changeset " "$sql_file"; then
            echo "âŒ No changesets found in $sql_file"
            VALIDATION_ERRORS=$((VALIDATION_ERRORS + 1))
          fi

          # 5. Check for potentially dangerous operations
          DANGEROUS_OPS=$(grep -in "DROP\|DELETE\|TRUNCATE" "$sql_file" | grep -v "^[[:space:]]*--" || true)
          if [ -n "$DANGEROUS_OPS" ]; then
            echo "âš ï¸  Potentially dangerous operations found in $sql_file:"
            echo "$DANGEROUS_OPS"
            echo "   Please review these operations carefully"
          fi

          echo "âœ… Basic validation passed for $sql_file"
        done

        if [ $VALIDATION_ERRORS -gt 0 ]; then
          echo ""
          echo "âŒ SQL validation failed with $VALIDATION_ERRORS error(s)"
          echo "ğŸ”§ Please fix the syntax errors above before proceeding"
          exit 1
        else
          echo ""
          echo "âœ… All SQL files passed basic syntax validation"
        fi

    - name: Liquibase offline validation
      run: |
        echo "ğŸ§ª Running Liquibase offline validation for ${{ matrix.database }}..."

        # Create temporary offline configuration for validation
        cat > liquibase-${{ matrix.database }}-validation.properties << 'EOF'
        changelogFile=changelog-${{ matrix.database }}.xml
        url=offline:postgresql
        driver=org.postgresql.Driver
        logLevel=INFO
        logFile=liquibase-${{ matrix.database }}-validation.log
        outputFile=liquibase-${{ matrix.database }}-validation-output.txt
        EOF

        # Run Liquibase validation in offline mode
        if ./liquibase --defaults-file=liquibase-${{ matrix.database }}-validation.properties validate; then
          echo "âœ… Liquibase offline validation PASSED for ${{ matrix.database }}"
        else
          echo "âŒ Liquibase offline validation FAILED for ${{ matrix.database }}"
          echo "ğŸ“„ Validation log:"
          if [ -f "liquibase-${{ matrix.database }}-validation.log" ]; then
            cat "liquibase-${{ matrix.database }}-validation.log"
          fi
          exit 1
        fi

        # Generate SQL preview in offline mode to catch additional issues
        echo "ğŸ“‹ Generating SQL preview to validate changeset logic..."
        if ./liquibase --defaults-file=liquibase-${{ matrix.database }}-validation.properties update-sql > planned-changes-${{ matrix.database }}-validation.sql; then
          echo "âœ… SQL generation succeeded"

          # Show a preview of what would be executed
          echo "ğŸ“„ SQL Preview (first 20 lines):"
          head -20 planned-changes-${{ matrix.database }}-validation.sql | nl

          # Check for safety patterns
          SAFETY_CHECKS=0
          if grep -q "IF NOT EXISTS\|CREATE OR REPLACE\|preconditions onFail:MARK_RAN" planned-changes-${{ matrix.database }}-validation.sql; then
            echo "âœ… Safety patterns detected (IF NOT EXISTS/CREATE OR REPLACE/preconditions)"
            SAFETY_CHECKS=$((SAFETY_CHECKS + 1))
          fi

          if ! grep -q "DROP TABLE\|DELETE FROM\|TRUNCATE" planned-changes-${{ matrix.database }}-validation.sql; then
            echo "âœ… No destructive operations detected"
            SAFETY_CHECKS=$((SAFETY_CHECKS + 1))
          else
            echo "âš ï¸  Destructive operations detected - please review carefully"
          fi

          echo "ğŸ›¡ï¸  Safety checks passed: $SAFETY_CHECKS/2"
        else
          echo "âŒ SQL generation failed"
          exit 1
        fi

        # Cleanup temporary files
        rm -f liquibase-${{ matrix.database }}-validation.properties
        rm -f liquibase-${{ matrix.database }}-validation.log
        rm -f liquibase-${{ matrix.database }}-validation-output.txt
        rm -f planned-changes-${{ matrix.database }}-validation.sql

    - name: Configure database connection
      run: |
        ./.github/scripts/configure-database.sh \
          ${{ matrix.database }} \
          ${{ vars.SECRET_NAME || 'liquibase-databases' }} \
          ${{ needs.discover-databases.outputs.test-mode }}

    - name: Create database if needed
      if: needs.discover-databases.outputs.test-mode == 'false'
      run: |
        echo "ğŸ—ï¸ Ensuring database exists for ${{ matrix.database }}..."
        echo "ğŸ” Test mode: ${{ needs.discover-databases.outputs.test-mode }}"
        echo "ğŸ” Matrix database: ${{ matrix.database }}"

        # Extract database type and name from the configuration
        DB_TYPE=$(grep -E "^url=" liquibase-${{ matrix.database }}.properties | sed 's/url=jdbc://' | cut -d: -f1)

        # Extract database name based on database type
        DB_URL=$(grep -E "^url=" liquibase-${{ matrix.database }}.properties | sed 's/url=//')
        if [ "$DB_TYPE" = "sqlserver" ]; then
          # SQL Server uses databaseName= parameter
          DB_NAME=$(echo "$DB_URL" | sed -n 's/.*databaseName=\([^;]*\).*/\1/p')
        else
          # PostgreSQL, MySQL use /database format
          DB_NAME=$(echo "$DB_URL" | sed 's/.*\///' | sed 's/;.*//' | sed 's/?.*//')
        fi

        # Only create database in deploy mode (not test mode)
        SECRET_NAME="${{ vars.SECRET_NAME || 'liquibase-databases' }}"

        echo "ğŸ”§ Creating database: $DB_NAME (type: $DB_TYPE)"

        if [ "$DB_TYPE" = "postgresql" ]; then
          if ! ./.github/scripts/create-database.sh postgresql "$DB_NAME" "$SECRET_NAME"; then
            echo "âŒ Failed to create PostgreSQL database: $DB_NAME"
            exit 1
          fi
        elif [ "$DB_TYPE" = "mysql" ]; then
          if ! ./.github/scripts/create-database.sh mysql "$DB_NAME" "$SECRET_NAME"; then
            echo "âŒ Failed to create MySQL database: $DB_NAME"
            exit 1
          fi
        elif [ "$DB_TYPE" = "sqlserver" ]; then
          if ! ./.github/scripts/create-database.sh sqlserver "$DB_NAME" "$SECRET_NAME"; then
            echo "âŒ Failed to create SQL Server database: $DB_NAME"
            exit 1
          fi
        elif [ "$DB_TYPE" = "oracle" ]; then
          if ! ./.github/scripts/create-database.sh oracle "$DB_NAME" "$SECRET_NAME"; then
            echo "âŒ Failed to create Oracle database: $DB_NAME"
            exit 1
          fi
        else
          echo "â„¹ï¸ Unknown database type: $DB_TYPE - skipping database creation"
        fi

        echo "âœ… Database creation completed for: $DB_NAME"

    - name: Validate changelog
      run: |
        if ! ./.github/scripts/run-liquibase.sh ${{ matrix.database }} validate; then
          echo "âš ï¸ Validation failed, likely due to checksum mismatch. Clearing checksums..."
          ./.github/scripts/run-liquibase.sh ${{ matrix.database }} clear-checksums
          echo "âœ… Checksums cleared. Re-running validation..."
          ./.github/scripts/run-liquibase.sh ${{ matrix.database }} validate
        fi

    - name: Run deployment or generate test SQL
      run: |
        if [ "${{ needs.discover-databases.outputs.test-mode }}" = "true" ]; then
          echo "ğŸ§ª Running in TEST mode"
          ./.github/scripts/run-liquibase.sh ${{ matrix.database }} update-sql true

          echo ""
          echo "ğŸ¯ TEST SUMMARY for ${{ matrix.database }}:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Changelog validation: PASSED"
          echo "âœ… SQL generation: COMPLETED"
          echo "ğŸ“ Artifacts will be uploaded for review"
          echo "ğŸš€ Ready for deployment when merged to main branch"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
          echo "ğŸš€ Running in DEPLOY mode"
          ./.github/scripts/run-liquibase.sh ${{ matrix.database }} update
          ./.github/scripts/run-liquibase.sh ${{ matrix.database }} status
        fi

    - name: Cleanup sensitive files
      if: always()
      run: ./.github/scripts/cleanup.sh ${{ matrix.database }}

    - name: Show workflow status
      if: always()
      run: |
        if [ "${{ job.status }}" = "success" ]; then
          echo "ğŸ‰ Workflow completed successfully for ${{ matrix.database }}"
        else
          echo "âŒ Workflow failed for ${{ matrix.database }}"
          echo "ğŸ” Check the logs above for error details"
        fi

    - name: Upload test results
      if: needs.discover-databases.outputs.test-mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.database }}
        path: |
          planned-changes-${{ matrix.database }}.sql
          liquibase-${{ matrix.database }}.log

    - name: Upload deployment artifacts
      if: needs.discover-databases.outputs.test-mode == 'false'
      uses: actions/upload-artifact@v4
      with:
        name: deployment-results-${{ matrix.database }}
        path: |
          planned-changes-${{ matrix.database }}.sql
          liquibase-${{ matrix.database }}.log
          liquibase-${{ matrix.database }}-output.txt

    - name: Upload logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: failure-logs-${{ matrix.database }}
        path: |
          liquibase-${{ matrix.database }}.log
          liquibase-${{ matrix.database }}-output.txt